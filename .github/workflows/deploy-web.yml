name: Deploy Web

on:
  # Trigger after Web CI completes successfully
  workflow_run:
    workflows: ["Web CI"]
    types:
      - completed
    branches: [main, develop]
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only deploy if CI succeeded (or manual trigger)
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # For workflow_run, checkout the branch that triggered CI
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        working-directory: ./web
        run: npm ci

      - name: Determine environment
        id: env
        run: |
          # For workflow_run events, use head_branch; for workflow_dispatch, use ref
          BRANCH="${{ github.event.workflow_run.head_branch || github.ref_name }}"
          echo "Detected branch: $BRANCH"

          if [ "$BRANCH" = "main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "firebase_project_id=wego-bac88" >> $GITHUB_OUTPUT
            echo "app_name=WeGo" >> $GITHUB_OUTPUT
          else
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "firebase_project_id=wego-dev-a5a13" >> $GITHUB_OUTPUT
            echo "app_name=WeGo (Dev)" >> $GITHUB_OUTPUT
          fi

      - name: Create environment file (DEV)
        if: steps.env.outputs.environment == 'development'
        working-directory: ./web
        env:
          VITE_APP_NAME: ${{ steps.env.outputs.app_name }}
          VITE_FIREBASE_API_KEY: ${{ secrets.DEV_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.DEV_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.DEV_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.DEV_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.DEV_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.DEV_FIREBASE_APP_ID }}
          VITE_GA4_MEASUREMENT_ID: ${{ secrets.DEV_GA4_MEASUREMENT_ID }}
        run: |
          echo "VITE_APP_NAME=${VITE_APP_NAME}" >> .env.local
          echo "VITE_FIREBASE_API_KEY=${VITE_FIREBASE_API_KEY}" >> .env.local
          echo "VITE_FIREBASE_AUTH_DOMAIN=${VITE_FIREBASE_AUTH_DOMAIN}" >> .env.local
          echo "VITE_FIREBASE_PROJECT_ID=${VITE_FIREBASE_PROJECT_ID}" >> .env.local
          echo "VITE_FIREBASE_STORAGE_BUCKET=${VITE_FIREBASE_STORAGE_BUCKET}" >> .env.local
          echo "VITE_FIREBASE_MESSAGING_SENDER_ID=${VITE_FIREBASE_MESSAGING_SENDER_ID}" >> .env.local
          echo "VITE_FIREBASE_APP_ID=${VITE_FIREBASE_APP_ID}" >> .env.local
          echo "VITE_GA4_MEASUREMENT_ID=${VITE_GA4_MEASUREMENT_ID}" >> .env.local
          echo "Created .env.local (serverless - no backend URL)"

      - name: Create environment file (PROD)
        if: steps.env.outputs.environment == 'production'
        working-directory: ./web
        env:
          VITE_APP_NAME: ${{ steps.env.outputs.app_name }}
          VITE_FIREBASE_API_KEY: ${{ secrets.PROD_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.PROD_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.PROD_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.PROD_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.PROD_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.PROD_FIREBASE_APP_ID }}
          VITE_FIREBASE_MEASUREMENT_ID: ${{ secrets.PROD_FIREBASE_MEASUREMENT_ID }}
          VITE_GA4_MEASUREMENT_ID: ${{ secrets.PROD_GA4_MEASUREMENT_ID }}
        run: |
          echo "VITE_APP_NAME=${VITE_APP_NAME}" >> .env.local
          echo "VITE_FIREBASE_API_KEY=${VITE_FIREBASE_API_KEY}" >> .env.local
          echo "VITE_FIREBASE_AUTH_DOMAIN=${VITE_FIREBASE_AUTH_DOMAIN}" >> .env.local
          echo "VITE_FIREBASE_PROJECT_ID=${VITE_FIREBASE_PROJECT_ID}" >> .env.local
          echo "VITE_FIREBASE_STORAGE_BUCKET=${VITE_FIREBASE_STORAGE_BUCKET}" >> .env.local
          echo "VITE_FIREBASE_MESSAGING_SENDER_ID=${VITE_FIREBASE_MESSAGING_SENDER_ID}" >> .env.local
          echo "VITE_FIREBASE_APP_ID=${VITE_FIREBASE_APP_ID}" >> .env.local
          echo "VITE_FIREBASE_MEASUREMENT_ID=${VITE_FIREBASE_MEASUREMENT_ID}" >> .env.local
          echo "VITE_GA4_MEASUREMENT_ID=${VITE_GA4_MEASUREMENT_ID}" >> .env.local
          echo "Created .env.local (serverless - no backend URL)"

      - name: Lint
        working-directory: ./web
        run: npm run lint

      - name: Type check
        working-directory: ./web
        run: npx tsc --noEmit

      - name: Run tests
        working-directory: ./web
        run: npm test -- --passWithNoTests

      - name: Build
        working-directory: ./web
        run: npm run build

      - name: Install Cloud Functions dependencies
        working-directory: ./web/functions
        run: npm ci

      - name: Build Cloud Functions
        working-directory: ./web/functions
        run: npm run build

      - name: Enable Maintenance Mode
        working-directory: ./web
        env:
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ steps.env.outputs.environment == 'production' && secrets.FIREBASE_SERVICE_ACCOUNT_PROD || secrets.FIREBASE_SERVICE_ACCOUNT_DEV }}
        run: |
          echo "$GOOGLE_APPLICATION_CREDENTIALS_JSON" > /tmp/firebase-key.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase-key.json
          npx tsx scripts/toggle-maintenance.ts on ${{ steps.env.outputs.firebase_project_id }}
          rm -f /tmp/firebase-key.json

      - name: Set Cloud Functions environment variables
        working-directory: ./web/functions
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Write environment variables to .env file for Cloud Functions
          # This avoids Secret Manager permission issues during deployment
          echo "OPENAI_API_KEY=${OPENAI_API_KEY}" > .env
          echo "Created .env file for Cloud Functions"

      - name: Deploy Cloud Functions
        working-directory: ./web
        env:
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ steps.env.outputs.environment == 'production' && secrets.FIREBASE_SERVICE_ACCOUNT_PROD || secrets.FIREBASE_SERVICE_ACCOUNT_DEV }}
        run: |
          echo "$GOOGLE_APPLICATION_CREDENTIALS_JSON" > /tmp/firebase-key.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase-key.json
          npx firebase-tools deploy --only functions --project ${{ steps.env.outputs.firebase_project_id }} --non-interactive --force
          rm -f /tmp/firebase-key.json

      - name: Deploy Firestore Rules and Indexes
        working-directory: ./web
        env:
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ steps.env.outputs.environment == 'production' && secrets.FIREBASE_SERVICE_ACCOUNT_PROD || secrets.FIREBASE_SERVICE_ACCOUNT_DEV }}
        run: |
          echo "$GOOGLE_APPLICATION_CREDENTIALS_JSON" > /tmp/firebase-key.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase-key.json
          npx firebase-tools deploy --only firestore:rules,firestore:indexes --project ${{ steps.env.outputs.firebase_project_id }} --non-interactive
          rm -f /tmp/firebase-key.json

      - name: Deploy Storage Rules
        working-directory: ./web
        env:
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ steps.env.outputs.environment == 'production' && secrets.FIREBASE_SERVICE_ACCOUNT_PROD || secrets.FIREBASE_SERVICE_ACCOUNT_DEV }}
        run: |
          echo "$GOOGLE_APPLICATION_CREDENTIALS_JSON" > /tmp/firebase-key.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase-key.json
          npx firebase-tools deploy --only storage --project ${{ steps.env.outputs.firebase_project_id }} --non-interactive
          rm -f /tmp/firebase-key.json

      - name: Deploy Remote Config
        working-directory: ./web
        env:
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ steps.env.outputs.environment == 'production' && secrets.FIREBASE_SERVICE_ACCOUNT_PROD || secrets.FIREBASE_SERVICE_ACCOUNT_DEV }}
        run: |
          echo "$GOOGLE_APPLICATION_CREDENTIALS_JSON" > /tmp/firebase-key.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase-key.json
          npx tsx scripts/deploy-remote-config.ts ${{ steps.env.outputs.firebase_project_id }}
          rm -f /tmp/firebase-key.json

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ steps.env.outputs.environment == 'production' && secrets.FIREBASE_SERVICE_ACCOUNT_PROD || secrets.FIREBASE_SERVICE_ACCOUNT_DEV }}
          projectId: ${{ steps.env.outputs.firebase_project_id }}
          channelId: live
          entryPoint: ./web

      - name: Disable Maintenance Mode
        if: always()
        working-directory: ./web
        env:
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ steps.env.outputs.environment == 'production' && secrets.FIREBASE_SERVICE_ACCOUNT_PROD || secrets.FIREBASE_SERVICE_ACCOUNT_DEV }}
        run: |
          echo "$GOOGLE_APPLICATION_CREDENTIALS_JSON" > /tmp/firebase-key.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase-key.json
          npx tsx scripts/toggle-maintenance.ts off ${{ steps.env.outputs.firebase_project_id }}
          rm -f /tmp/firebase-key.json
